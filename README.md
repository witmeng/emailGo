# EmailGo - 基於 XLSX 的郵件批量發送工具

一個 Node.js 工具，允許用戶上傳 XLSX 文件，根據文件中的數據和用戶定義的模板批量發送個性化郵件，並將發送結果回寫到 XLSX 文件中。

## 核心功能

*   **XLSX 文件驅動**: 從 XLSX 文件讀取收件人列表和郵件內容變量。
*   **動態表頭**: XLSX 文件的第一行作為表頭，用於郵件模板中的佔位符。
*   **郵件模板**: 支持自定義郵件主題和正文模板。
*   **富文本編輯**: 使用 Quill.js 進行郵件正文的富文本編輯。
*   **附件支持**: 允許上傳多個附件隨郵件發送，並可在發送前移除。
*   **實時進度**: 通過 Server-Sent Events (SSE) 實時更新郵件發送進度到前端。
*   **狀態回寫**: 將每封郵件的發送狀態（成功/失敗）和發送時間回寫到 XLSX 文件中。
*   **重複發送避免**: 檢查 XLSX 文件中的狀態列，跳過已標記為成功的郵件。
*   **配置靈活**: 通過 `.env` 文件配置 SMTP 服務器信息和發件人信息。
*   **發件人校驗**: 啟動時校驗 `.env` 中 `EMAIL_USER` 和 `EMAIL_FROM_EMAIL` 的一致性。
*   **頻率控制**: 可設置每封郵件的發送間隔。
*   **結果下載**: 提供處理完成後（包含最新狀態）的 XLSX 文件下載。
*   **用戶界面**: 簡單直觀的前端頁面進行操作。
*   **模態框提示**: 使用模態框進行用戶交互提示。
*   **模板持久化**: 郵件主題和正文模板會保存在瀏覽器的 localStorage 中，方便下次使用。
*   **文件名處理**: 解決了中文文件名在附件、服務器存儲和下載時的亂碼問題。
*   **內嵌圖片處理**: 自動將粘貼到富文本編輯器中的圖片轉換為 CID 內嵌附件，提高兼容性。

## 技術棧

*   **後端**: Node.js, Express.js
*   **郵件發送**: Nodemailer
*   **XLSX 處理**: xlsx
*   **文件上傳**: Multer
*   **配置管理**: dotenv
*   **唯一ID生成**: uuid
*   **前端**: HTML, CSS, JavaScript (原生)
*   **富文本編輯器**: Quill.js
*   **實時通信**: Server-Sent Events (SSE)

## 環境準備

*   Node.js (建議 LTS 版本，例如 v18.x 或更高版本)
*   npm (通常隨 Node.js 一起安裝)

## 安裝步驟

1.  克隆或下載本倉庫到本地。
2.  打開終端，進入項目根目錄。
3.  運行以下命令安裝依賴：
    ```bash
    npm install
    ```

## 配置 (`.env` 文件)

在項目根目錄下創建一個名為 `.env` 的文件，並根據您的郵件服務商信息填寫以下內容：

```dotenv
# SMTP 服務器配置
EMAIL_HOST=smtp.example.com
EMAIL_PORT=465 # 或 587, 25 等，取決於您的服務商和安全設置
EMAIL_SECURE=true # 如果端口是 465 則為 true，其他端口通常為 false (例如 587 使用 STARTTLS)
EMAIL_USER=your_email_address@example.com # 您的郵箱賬號，用於SMTP認證
EMAIL_PASS=your_email_password # 您的郵箱密碼或應用專用密碼

# 發件人信息
EMAIL_FROM_NAME="您的發件人名稱" # 郵件中顯示的發件人名稱
EMAIL_FROM_EMAIL=your_email_address@example.com # 郵件中顯示的發件人郵箱地址

# 服務器端口 (可選, 默認為 3000)
# PORT=3000
```

**重要提示**: 
*   `EMAIL_USER` 和 `EMAIL_FROM_EMAIL` 的值必須完全一致。服務器啟動時會進行校驗。
*   如果使用 Gmail，您可能需要為您的賬戶啟用 "允許不安全應用訪問" 或生成 "應用專用密碼"。
*   請確保 `EMAIL_PORT` 和 `EMAIL_SECURE` 的設置與您的郵件服務商要求匹配，以避免 SSL/TLS 錯誤。

## XLS 文件格式要求

*   上傳的 XLSX 文件的第一行必須是**表頭**。這些表頭將用作郵件模板中的佔位符，例如 `{{列名}}`。
*   文件必須包含以下固定意義的列（列名可以自定義，但建議使用英文）：
    *   `email` (或類似名稱): 包含收件人的郵箱地址。 (必需)
    *   `title` (或類似名稱): 包含該行數據特定的郵件主題。如果此列有內容，將覆蓋全局的郵件主題模板。 (可選)
*   程序會自動處理（如果列存在則更新，不存在則可能嘗試添加，但建議預先創建好）以下列：
    *   `status` (或類似名稱): 用於記錄郵件發送狀態 (例如：成功, 失敗: 錯誤信息, skipped_previously_success)。
    *   `send_time` (或類似名稱): 用於記錄郵件發送的時間。
*   所有其他列都可以作為郵件內容的佔位符使用。

## 運行方法

完成安裝和 `.env` 配置後，在項目根目錄下運行：

```bash
npm start
```

服務將默認啟動在 `http://localhost:3000` (除非您在 `.env` 中指定了不同的 `PORT`)。

## 前端界面功能說明

訪問服務地址 (例如 `http://localhost:3000`) 即可看到操作界面。

1.  **XLSX 文件上傳與預覽**:
    *   點擊 "選擇文件" 上傳您的 XLSX 文件。
    *   點擊 "預覽並載入佔位符" 按鈕。服務器會解析文件，並在下方顯示文件信息、可用佔位符列表以及前幾行數據預覽。
2.  **郵件模板編輯**:
    *   **主題模板**: 輸入郵件主題。您可以使用從 XLSX 文件表頭中提取的佔位符，例如 `你好 {{姓名}}`。
    *   **正文模板**: 使用下方的 Quill.js 富文本編輯器編寫郵件正文。同樣支持佔位符。您可以粘貼圖片，它們會被作為內嵌附件處理。
    *   主題和正文模板會自動保存到瀏覽器的 `localStorage`，下次打開頁面時會自動載入。
3.  **附件管理**:
    *   點擊 "選擇文件" (在附件部分) 可以選擇一個或多個文件作為郵件附件。
    *   已選擇的附件會列表顯示，您可以點擊每個附件旁邊的 "移除" 按鈕來取消該附件。
4.  **發送控制與進度顯示**:
    *   **發送間隔**: 設置每封郵件之間發送的延遲時間（秒）。0 表示無延遲。
    *   點擊 "開始發送" 按鈕啟動郵件發送任務。
    *   下方會實時顯示總體進度條、當前處理的郵件信息、成功/失敗統計以及詳細的錯誤日誌。
5.  **結果下載**:
    *   郵件全部處理完成後，會出現一個下載鏈接，您可以點擊下載包含最新發送狀態和時間的 XLSX 文件。

## API 接口 (簡要)

*   `POST /upload-and-preview`: 上傳 XLSX 文件，解析表頭和預覽數據。
*   `POST /initiate-sending-job`: 接收郵件參數（XLSX 文件路徑、模板、附件等），初始化郵件發送作業，返回作業ID。
*   `GET /send-emails-stream?jobId=<ID>`: 建立 SSE 連接，根據作業ID執行郵件批量發送，並通過事件流推送實時進度。

## 注意事項

*   **反垃圾郵件**: 
    *   請勿濫用此工具發送垃圾郵件。遵守相關法律法規。
    *   確保您的郵件列表是經過許可的 (Opt-in)。
    *   郵件內容應高質量、相關性強，避免使用過多的大寫字母、驚歎號和可能觸發垃圾郵件過濾器的詞彙。
    *   合理設置發送間隔，過快的頻率可能導致被郵件服務商標記為垃圾郵件發送者。
    *   關注退信率和投訴率。
    *   考慮添加退訂鏈接 (本工具目前未直接集成，可手動在模板中加入說明)。
*   **安全性**: `.env` 文件中的密碼等敏感信息請妥善保管，不要提交到版本控制系統 (例如，將 `.env` 添加到 `.gitignore` 文件中)。
*   **錯誤處理**: 仔細查看前端錯誤日誌和服務器控制台輸出，以便排查問題。

## 未來可能的改進

- 實時進度更新 (使用 WebSocket 或 Server-Sent Events)。
- 更詳細的單封郵件發送日誌記錄。
- 郵件模板保存和管理功能。
- 支持 CSV 文件格式。
- 更靈活的狀態列和時間列配置。
- 郵件預覽功能（基於第一條數據渲染模板）。

---

希望這份 README 對您有所幫助！ 